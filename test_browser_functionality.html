<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Test Redesigned SQL Generator</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #2196f3;
        }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .code { 
            background: #f0f0f0; 
            padding: 8px; 
            font-family: monospace; 
            margin: 8px 0; 
            border-radius: 4px;
        }
        button { 
            padding: 8px 16px; 
            margin: 4px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .test-btn { background: #2196f3; color: white; }
        .clear-btn { background: #f44336; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ§ª SQL Generator é‡æ–°è¨­è¨ˆåŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š INSERT æ“ä½œæ¸¬è©¦</h2>
        <button class="test-btn" onclick="testInsertOperation()">æ¸¬è©¦ INSERT æ“ä½œ</button>
        <div id="insert-test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ UPDATE æ“ä½œæ¸¬è©¦</h2>
        <button class="test-btn" onclick="testUpdateOperation()">æ¸¬è©¦ UPDATE æ“ä½œ</button>
        <div id="update-test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ›¡ï¸ å®‰å…¨æ€§æ¸¬è©¦</h2>
        <button class="test-btn" onclick="testSecurityFeatures()">æ¸¬è©¦ SQL æ³¨å…¥é˜²è­·</button>
        <div id="security-test-results"></div>
    </div>

    <div class="test-section">
        <h2>âš ï¸ éŒ¯èª¤è™•ç†æ¸¬è©¦</h2>
        <button class="test-btn" onclick="testErrorHandling()">æ¸¬è©¦éŒ¯èª¤è™•ç†</button>
        <div id="error-test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ æ“ä½œæ¨¡å¼åˆ‡æ›æ¸¬è©¦</h2>
        <button class="test-btn" onclick="testModeSwitch()">æ¸¬è©¦æ¨¡å¼åˆ‡æ›</button>
        <div id="mode-test-results"></div>
    </div>

    <div class="test-section">
        <button class="clear-btn" onclick="clearAllResults()">æ¸…é™¤æ‰€æœ‰æ¸¬è©¦çµæœ</button>
    </div>

    <!-- Load the redesigned popup script -->
    <script src="popup.js"></script>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : 
                             type === 'error' ? 'error' : 
                             type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function logCode(elementId, code) {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="code">${code}</div>`;
        }

        function testInsertOperation() {
            const results = document.getElementById('insert-test-results');
            results.innerHTML = '';
            
            try {
                log('insert-test-results', 'é–‹å§‹æ¸¬è©¦ INSERT æ“ä½œè™•ç†å™¨...', 'info');
                
                // Create INSERT handler instance
                const insertHandler = new InsertOperationHandler();
                log('insert-test-results', 'âœ… INSERT è™•ç†å™¨å‰µå»ºæˆåŠŸ', 'success');
                
                // Set table name
                insertHandler.setTableName('users');
                log('insert-test-results', 'âœ… è¡¨åè¨­å®šæˆåŠŸ: users', 'success');
                
                // Add fields
                insertHandler.addField('name', 'John Doe', 'string');
                insertHandler.addField('age', 30, 'number');
                insertHandler.addField('active', true, 'boolean');
                insertHandler.addField('email', 'john@example.com', 'string');
                log('insert-test-results', 'âœ… æ¬„ä½æ–°å¢æˆåŠŸ (4å€‹æ¬„ä½)', 'success');
                
                // Validate
                const isValid = insertHandler.validate();
                if (isValid) {
                    log('insert-test-results', 'âœ… é©—è­‰é€šé', 'success');
                    
                    // Generate SQL
                    const sql = insertHandler.generateSQL();
                    log('insert-test-results', 'âœ… SQL ç”ŸæˆæˆåŠŸ:', 'success');
                    logCode('insert-test-results', sql);
                } else {
                    log('insert-test-results', 'âŒ é©—è­‰å¤±æ•—: ' + insertHandler.getValidationErrors().join(', '), 'error');
                }
                
            } catch (error) {
                log('insert-test-results', 'âŒ æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function testUpdateOperation() {
            const results = document.getElementById('update-test-results');
            results.innerHTML = '';
            
            try {
                log('update-test-results', 'é–‹å§‹æ¸¬è©¦ UPDATE æ“ä½œè™•ç†å™¨...', 'info');
                
                // Create UPDATE handler instance
                const updateHandler = new UpdateOperationHandler();
                log('update-test-results', 'âœ… UPDATE è™•ç†å™¨å‰µå»ºæˆåŠŸ', 'success');
                
                // Set table name
                updateHandler.setTableName('users');
                log('update-test-results', 'âœ… è¡¨åè¨­å®šæˆåŠŸ: users', 'success');
                
                // Add SET fields
                updateHandler.addSetField('email', 'newemail@example.com', 'string');
                updateHandler.addSetField('age', 31, 'number');
                updateHandler.addSetField('last_login', new Date().toISOString(), 'string');
                log('update-test-results', 'âœ… SET æ¬„ä½æ–°å¢æˆåŠŸ (3å€‹æ¬„ä½)', 'success');
                
                // Add WHERE conditions
                updateHandler.addWhereCondition('id', '=', 1, 'number');
                updateHandler.addWhereCondition('status', '=', 'active', 'string', 'AND');
                updateHandler.addWhereCondition('created_date', '>', '2023-01-01', 'string', 'AND');
                log('update-test-results', 'âœ… WHERE æ¢ä»¶æ–°å¢æˆåŠŸ (3å€‹æ¢ä»¶)', 'success');
                
                // Validate
                const isValid = updateHandler.validate();
                if (isValid) {
                    log('update-test-results', 'âœ… é©—è­‰é€šé', 'success');
                    
                    // Generate SQL
                    const sql = updateHandler.generateSQL();
                    log('update-test-results', 'âœ… SQL ç”ŸæˆæˆåŠŸ:', 'success');
                    logCode('update-test-results', sql);
                } else {
                    log('update-test-results', 'âŒ é©—è­‰å¤±æ•—: ' + updateHandler.getValidationErrors().join(', '), 'error');
                }
                
            } catch (error) {
                log('update-test-results', 'âŒ æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function testSecurityFeatures() {
            const results = document.getElementById('security-test-results');
            results.innerHTML = '';
            
            try {
                log('security-test-results', 'é–‹å§‹æ¸¬è©¦ SQL æ³¨å…¥é˜²è­·...', 'info');
                
                // Test SQL injection in INSERT
                const insertHandler = new InsertOperationHandler();
                insertHandler.setTableName('users');
                insertHandler.addField('name', "'; DROP TABLE users; --", 'string');
                insertHandler.addField('email', "admin@test.com' OR '1'='1", 'string');
                
                const insertSQL = insertHandler.generateSQL();
                log('security-test-results', 'âœ… INSERT æ³¨å…¥é˜²è­·æ¸¬è©¦:', 'success');
                logCode('security-test-results', insertSQL);
                
                if (insertSQL.includes("''")) {
                    log('security-test-results', 'âœ… å–®å¼•è™Ÿæ­£ç¢ºè½‰ç¾©', 'success');
                } else {
                    log('security-test-results', 'âš ï¸ å–®å¼•è™Ÿè½‰ç¾©å¯èƒ½æœ‰å•é¡Œ', 'warning');
                }
                
                // Test SQL injection in UPDATE
                const updateHandler = new UpdateOperationHandler();
                updateHandler.setTableName('users');
                updateHandler.addSetField('name', "'; UPDATE users SET role='admin'; --", 'string');
                updateHandler.addWhereCondition('id', '=', "1' OR '1'='1", 'string');
                
                const updateSQL = updateHandler.generateSQL();
                log('security-test-results', 'âœ… UPDATE æ³¨å…¥é˜²è­·æ¸¬è©¦:', 'success');
                logCode('security-test-results', updateSQL);
                
            } catch (error) {
                log('security-test-results', 'âŒ å®‰å…¨æ€§æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function testErrorHandling() {
            const results = document.getElementById('error-test-results');
            results.innerHTML = '';
            
            log('error-test-results', 'é–‹å§‹æ¸¬è©¦éŒ¯èª¤è™•ç†...', 'info');
            
            // Test 1: Empty INSERT handler
            try {
                const emptyInsertHandler = new InsertOperationHandler();
                emptyInsertHandler.generateSQL();
                log('error-test-results', 'âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
            } catch (error) {
                log('error-test-results', 'âœ… æ­£ç¢ºæ•ç²ç©º INSERT éŒ¯èª¤: ' + error.message, 'success');
            }
            
            // Test 2: Empty UPDATE handler
            try {
                const emptyUpdateHandler = new UpdateOperationHandler();
                emptyUpdateHandler.generateSQL();
                log('error-test-results', 'âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
            } catch (error) {
                log('error-test-results', 'âœ… æ­£ç¢ºæ•ç²ç©º UPDATE éŒ¯èª¤: ' + error.message, 'success');
            }
            
            // Test 3: Invalid table name
            try {
                const handler = new InsertOperationHandler();
                handler.setTableName('');
                log('error-test-results', 'âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
            } catch (error) {
                log('error-test-results', 'âœ… æ­£ç¢ºæ•ç²ç„¡æ•ˆè¡¨åéŒ¯èª¤: ' + error.message, 'success');
            }
            
            // Test 4: Invalid operator in WHERE
            try {
                const handler = new UpdateOperationHandler();
                handler.setTableName('test');
                handler.addSetField('name', 'test', 'string');
                handler.addWhereCondition('id', 'INVALID_OP', '1', 'number');
                log('error-test-results', 'âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
            } catch (error) {
                log('error-test-results', 'âœ… æ­£ç¢ºæ•ç²ç„¡æ•ˆé‹ç®—ç¬¦éŒ¯èª¤: ' + error.message, 'success');
            }
        }

        function testModeSwitch() {
            const results = document.getElementById('mode-test-results');
            results.innerHTML = '';
            
            log('mode-test-results', 'é–‹å§‹æ¸¬è©¦æ¨¡å¼åˆ‡æ›åŠŸèƒ½...', 'info');
            
            try {
                // Test if we can access the global SQLGenerator instance
                if (typeof window !== 'undefined' && window.SQLGenerator) {
                    log('mode-test-results', 'âœ… SQLGenerator é¡åˆ¥å¯å­˜å–', 'success');
                } else {
                    log('mode-test-results', 'âš ï¸ SQLGenerator é¡åˆ¥ä¸åœ¨å…¨åŸŸç¯„åœä¸­', 'warning');
                }
                
                // Test INSERT and UPDATE handler classes
                if (typeof InsertOperationHandler !== 'undefined') {
                    log('mode-test-results', 'âœ… InsertOperationHandler å¯å­˜å–', 'success');
                } else {
                    log('mode-test-results', 'âš ï¸ InsertOperationHandler ä¸åœ¨å…¨åŸŸç¯„åœä¸­', 'warning');
                }
                
                if (typeof UpdateOperationHandler !== 'undefined') {
                    log('mode-test-results', 'âœ… UpdateOperationHandler å¯å­˜å–', 'success');
                } else {
                    log('mode-test-results', 'âš ï¸ UpdateOperationHandler ä¸åœ¨å…¨åŸŸç¯„åœä¸­', 'warning');
                }
                
                // Test different data types
                log('mode-test-results', 'æ¸¬è©¦ä¸åŒè³‡æ–™é¡å‹è™•ç†...', 'info');
                
                const handler = new InsertOperationHandler();
                handler.setTableName('test_types');
                handler.addField('string_field', 'test string', 'string');
                handler.addField('number_field', 123, 'number');
                handler.addField('boolean_field', true, 'boolean');
                handler.addField('null_field', null, 'null');
                handler.addField('date_field', '2024-01-01', 'string');
                
                const sql = handler.generateSQL();
                log('mode-test-results', 'âœ… å¤šç¨®è³‡æ–™é¡å‹è™•ç†æˆåŠŸ:', 'success');
                logCode('mode-test-results', sql);
                
            } catch (error) {
                log('mode-test-results', 'âŒ æ¨¡å¼åˆ‡æ›æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        function clearAllResults() {
            ['insert-test-results', 'update-test-results', 'security-test-results', 
             'error-test-results', 'mode-test-results'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // Auto-run a basic functionality test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª Redesigned SQL Generator test page loaded');
            console.log('âœ… INSERT and UPDATE handlers are available');
            console.log('ğŸ“ Click the test buttons to run comprehensive tests');
        });
    </script>
</body>
</html>