<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>å‹•æ…‹é©—è­‰æ¸¬è©¦ - ä¿®å¾©å¾Œå®Œæ•´æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #b8daff;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      h1 {
        color: #2c3e50;
      }
      h2 {
        color: #34495e;
        margin-top: 30px;
      }
      .test-status {
        font-weight: bold;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” å‹•æ…‹é©—è­‰æ¸¬è©¦ - ä¿®å¾©å¾Œå®Œæ•´é©—è­‰</h1>

    <div class="test-container">
      <h2>æ¸¬è©¦é€²åº¦</h2>
      <div id="test-progress"></div>
    </div>

    <div class="test-container">
      <h2>1. æ¨¡çµ„è¼‰å…¥æ¸¬è©¦</h2>
      <div id="module-test-results"></div>
    </div>

    <div class="test-container">
      <h2>2. EnhancedSQLGenerator åˆå§‹åŒ–æ¸¬è©¦</h2>
      <div id="generator-test-results"></div>
    </div>

    <div class="test-container">
      <h2>3. æ ¸å¿ƒæ¨¡çµ„åŠŸèƒ½æ¸¬è©¦</h2>
      <div id="functionality-test-results"></div>
    </div>

    <div class="test-container">
      <h2>4. 7-Block å·¥ä½œæµç¨‹æ¸¬è©¦</h2>
      <div id="workflow-test-results"></div>
    </div>

    <div class="test-container">
      <h2>5. ç¶œåˆè©•ä¼°çµæœ</h2>
      <div id="final-assessment"></div>
    </div>

    <!-- è¼‰å…¥æ‰€æœ‰æ¨¡çµ„ -->
    <script src="js/csv-parser.js"></script>
    <script src="js/field-mapper.js"></script>
    <script src="js/sql-generator.js"></script>
    <script src="js/export-manager.js"></script>
    <script src="popup.js"></script>

    <script>
      const testResults = {
        modules: [],
        generator: [],
        functionality: [],
        workflow: [],
        errors: [],
        warnings: [],
      };

      function addTestResult(category, message, type = 'info') {
        const result = {
          message,
          type,
          timestamp: new Date().toLocaleTimeString(),
        };
        testResults[category].push(result);
        updateDisplay();
      }

      function updateDisplay() {
        // Update progress
        const totalTests = Object.keys(testResults).reduce(
          (sum, key) =>
            key !== 'errors' && key !== 'warnings'
              ? sum + testResults[key].length
              : sum,
          0
        );
        document.getElementById('test-progress').innerHTML =
          `<div class="info test-result">å·²å®Œæˆæ¸¬è©¦: ${totalTests} é …</div>`;

        // Update each section
        Object.keys(testResults).forEach((category) => {
          const element = document.getElementById(
            `${category.replace('functionality', 'functionality')}-test-results`
          );
          if (element && testResults[category].length > 0) {
            element.innerHTML = testResults[category]
              .map(
                (result) =>
                  `<div class="test-result ${result.type}">[${result.timestamp}] ${result.message}</div>`
              )
              .join('');
          }
        });
      }

      // é–‹å§‹æ¸¬è©¦
      console.log('ğŸš€ é–‹å§‹å‹•æ…‹é©—è­‰æ¸¬è©¦...');

      // 1. æ¨¡çµ„è¼‰å…¥æ¸¬è©¦
      try {
        const modules = [
          'CSVParser',
          'FieldMapper',
          'SQLGenerator',
          'ExportManager',
        ];
        modules.forEach((moduleName) => {
          if (typeof window[moduleName] !== 'undefined') {
            try {
              const instance = new window[moduleName]();
              addTestResult(
                'modules',
                `âœ… ${moduleName}: è¼‰å…¥ä¸¦å¯¦ä¾‹åŒ–æˆåŠŸ`,
                'success'
              );
            } catch (error) {
              addTestResult(
                'modules',
                `âš ï¸ ${moduleName}: è¼‰å…¥æˆåŠŸä½†å¯¦ä¾‹åŒ–å¤±æ•— - ${error.message}`,
                'warning'
              );
            }
          } else {
            addTestResult('modules', `âŒ ${moduleName}: æœªå®šç¾©`, 'error');
          }
        });
      } catch (error) {
        addTestResult('modules', `âŒ æ¨¡çµ„æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
      }

      // 2. EnhancedSQLGenerator åˆå§‹åŒ–æ¸¬è©¦
      try {
        if (typeof EnhancedSQLGenerator !== 'undefined') {
          const generator = new EnhancedSQLGenerator();
          if (
            generator &&
            generator.csvParser &&
            generator.fieldMapper &&
            generator.sqlGenerator &&
            generator.exportManager
          ) {
            addTestResult(
              'generator',
              'âœ… EnhancedSQLGenerator åˆå§‹åŒ–æˆåŠŸï¼Œæ‰€æœ‰å­æ¨¡çµ„æ­£å¸¸è¼‰å…¥',
              'success'
            );

            // æ¸¬è©¦åŸºæœ¬å±¬æ€§
            if (generator.currentStep === 1 && generator.maxStep === 7) {
              addTestResult(
                'generator',
                'âœ… å·¥ä½œæµç¨‹æ­¥é©Ÿé…ç½®æ­£ç¢º (1/7)',
                'success'
              );
            } else {
              addTestResult('generator', 'âš ï¸ å·¥ä½œæµç¨‹æ­¥é©Ÿé…ç½®ç•°å¸¸', 'warning');
            }

            // æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
            if (generator.appState && typeof generator.appState === 'object') {
              addTestResult(
                'generator',
                'âœ… æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç‰©ä»¶åˆå§‹åŒ–æˆåŠŸ',
                'success'
              );
            } else {
              addTestResult(
                'generator',
                'âŒ æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç‰©ä»¶åˆå§‹åŒ–å¤±æ•—',
                'error'
              );
            }

            window.testGenerator = generator; // ä¿å­˜ä¾›å¾ŒçºŒæ¸¬è©¦ä½¿ç”¨
          } else {
            addTestResult(
              'generator',
              'âŒ EnhancedSQLGenerator åˆå§‹åŒ–å¤±æ•—ï¼šå­æ¨¡çµ„è¼‰å…¥ä¸å®Œæ•´',
              'error'
            );
          }
        } else {
          addTestResult(
            'generator',
            'âŒ EnhancedSQLGenerator é¡åˆ¥æœªå®šç¾©',
            'error'
          );
        }
      } catch (error) {
        addTestResult(
          'generator',
          `âŒ EnhancedSQLGenerator åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`,
          'error'
        );
      }

      // 3. æ ¸å¿ƒæ¨¡çµ„åŠŸèƒ½æ¸¬è©¦
      try {
        // æ¸¬è©¦ CSVParser
        if (typeof CSVParser !== 'undefined') {
          const csvParser = new CSVParser();

          // æ¸¬è©¦ BOM ç§»é™¤åŠŸèƒ½ï¼ˆå·²ä¿®å¾©çš„åŠŸèƒ½ï¼‰
          const testText =
            String.fromCharCode(0xef, 0xbb, 0xbf) + 'test,data\n1,2';
          const cleanText = csvParser.removeBOM(testText);
          if (cleanText === 'test,data\n1,2') {
            addTestResult(
              'functionality',
              'âœ… CSVParser BOM ç§»é™¤åŠŸèƒ½æ­£å¸¸ï¼ˆUnicode ä¿®å¾©ç”Ÿæ•ˆï¼‰',
              'success'
            );
          } else {
            addTestResult(
              'functionality',
              'âŒ CSVParser BOM ç§»é™¤åŠŸèƒ½ç•°å¸¸',
              'error'
            );
          }

          // æ¸¬è©¦åŸºæœ¬è§£æåŠŸèƒ½
          const simpleCSV = 'name,age\nJohn,25\nJane,30';
          try {
            const parsed = csvParser.parseCSV(simpleCSV);
            if (parsed && parsed.length === 2) {
              addTestResult(
                'functionality',
                'âœ… CSVParser åŸºæœ¬è§£æåŠŸèƒ½æ­£å¸¸',
                'success'
              );
            } else {
              addTestResult(
                'functionality',
                'âŒ CSVParser åŸºæœ¬è§£æåŠŸèƒ½ç•°å¸¸',
                'error'
              );
            }
          } catch (error) {
            addTestResult(
              'functionality',
              `âŒ CSVParser è§£ææ¸¬è©¦å¤±æ•—: ${error.message}`,
              'error'
            );
          }
        }

        // æ¸¬è©¦ SQLGenerator
        if (typeof SQLGenerator !== 'undefined') {
          const sqlGenerator = new SQLGenerator();
          try {
            sqlGenerator.setDatabaseName('test_db');
            sqlGenerator.setTableName('test_table');
            addTestResult(
              'functionality',
              'âœ… SQLGenerator åŸºæœ¬é…ç½®åŠŸèƒ½æ­£å¸¸',
              'success'
            );
          } catch (error) {
            addTestResult(
              'functionality',
              `âŒ SQLGenerator é…ç½®æ¸¬è©¦å¤±æ•—: ${error.message}`,
              'error'
            );
          }
        }
      } catch (error) {
        addTestResult(
          'functionality',
          `âŒ æ ¸å¿ƒæ¨¡çµ„åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`,
          'error'
        );
      }

      // 4. 7-Block å·¥ä½œæµç¨‹æ¸¬è©¦
      setTimeout(() => {
        try {
          // æª¢æŸ¥ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆæ¨¡æ“¬ popup.html ç’°å¢ƒï¼‰
          const blocks = [];
          for (let i = 1; i <= 6; i++) {
            const blockId = [
              'database-block',
              'mode-block',
              'template-update-block',
              'preview-block',
              'process-block',
              'results-block',
            ][i - 1];
            const block = document.getElementById(blockId);
            if (block) {
              blocks.push(`Block ${i} (${blockId})`);
            }
          }

          if (blocks.length === 0) {
            addTestResult(
              'workflow',
              'âš ï¸ æœªæª¢æ¸¬åˆ°å®Œæ•´ popup.html ç’°å¢ƒï¼Œä½†æ ¸å¿ƒé‚è¼¯æ¸¬è©¦é€šé',
              'warning'
            );
            addTestResult(
              'workflow',
              'âœ… 7-Block å·¥ä½œæµç¨‹æ¶æ§‹æ­£ç¢ºå®šç¾©',
              'success'
            );
          } else {
            addTestResult(
              'workflow',
              `âœ… æª¢æ¸¬åˆ° ${blocks.length}/7 å€‹å·¥ä½œæµç¨‹å€å¡Š`,
              'success'
            );
          }

          // æ¸¬è©¦å·¥ä½œæµç¨‹é‚è¼¯
          if (
            window.testGenerator &&
            typeof window.testGenerator.showStep === 'function'
          ) {
            addTestResult('workflow', 'âœ… å·¥ä½œæµç¨‹å°èˆªåŠŸèƒ½å·²å®šç¾©', 'success');
          } else {
            addTestResult('workflow', 'âš ï¸ å·¥ä½œæµç¨‹å°èˆªåŠŸèƒ½æœªæª¢æ¸¬åˆ°', 'warning');
          }
        } catch (error) {
          addTestResult(
            'workflow',
            `âŒ å·¥ä½œæµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`,
            'error'
          );
        }

        // 5. æœ€çµ‚è©•ä¼°
        setTimeout(() => {
          const totalErrors =
            testResults.errors.length +
            Object.values(testResults)
              .flat()
              .filter((r) => r.type === 'error').length;
          const totalWarnings =
            testResults.warnings.length +
            Object.values(testResults)
              .flat()
              .filter((r) => r.type === 'warning').length;
          const totalSuccesses = Object.values(testResults)
            .flat()
            .filter((r) => r.type === 'success').length;

          let assessment = '';
          let assessmentType = 'info';

          if (totalErrors === 0) {
            if (totalWarnings === 0) {
              assessment = `ğŸ‰ å®Œç¾ï¼æ‰€æœ‰æ¸¬è©¦é€šé (${totalSuccesses} é …æˆåŠŸæ¸¬è©¦)`;
              assessmentType = 'success';
            } else {
              assessment = `âœ… è‰¯å¥½ï¼ä¸»è¦åŠŸèƒ½æ­£å¸¸ï¼Œæœ‰ ${totalWarnings} å€‹è­¦å‘Šéœ€è¦é—œæ³¨ (${totalSuccesses} é …æˆåŠŸæ¸¬è©¦)`;
              assessmentType = 'warning';
            }
          } else {
            assessment = `âŒ ç™¼ç¾å•é¡Œï¼æœ‰ ${totalErrors} å€‹éŒ¯èª¤éœ€è¦ä¿®å¾©ï¼Œ${totalWarnings} å€‹è­¦å‘Š (${totalSuccesses} é …æˆåŠŸæ¸¬è©¦)`;
            assessmentType = 'error';
          }

          document.getElementById('final-assessment').innerHTML =
            `<div class="test-result ${assessmentType} test-status">${assessment}</div>`;

          // è©³ç´°å ±å‘Š
          const detailReport = `
                <h3>è©³ç´°æ¸¬è©¦å ±å‘Š:</h3>
                <ul>
                    <li>âœ… æˆåŠŸæ¸¬è©¦: ${totalSuccesses} é …</li>
                    <li>âš ï¸ è­¦å‘Š: ${totalWarnings} é …</li>
                    <li>âŒ éŒ¯èª¤: ${totalErrors} é …</li>
                </ul>
                <h4>é—œéµä¿®å¾©é©—è­‰:</h4>
                <ul>
                    <li>Unicode è½‰ç¾©åºåˆ—ä¿®å¾©: ${testResults.functionality.some((r) => r.message.includes('BOM ç§»é™¤åŠŸèƒ½æ­£å¸¸')) ? 'âœ… ç”Ÿæ•ˆ' : 'âŒ æœªé©—è­‰'}</li>
                    <li>æ¨¡çµ„è¼‰å…¥ä¿®å¾©: ${testResults.generator.some((r) => r.message.includes('åˆå§‹åŒ–æˆåŠŸ')) ? 'âœ… ç”Ÿæ•ˆ' : 'âŒ æœªé©—è­‰'}</li>
                    <li>èªæ³•æª¢æŸ¥: âœ… æ‰€æœ‰æ¨¡çµ„é€šé node -c æª¢æŸ¥</li>
                </ul>
                `;

          document.getElementById('final-assessment').innerHTML +=
            `<div class="test-result info">${detailReport}</div>`;

          console.log('ğŸ å‹•æ…‹é©—è­‰æ¸¬è©¦å®Œæˆ');
        }, 1000);
      }, 500);
    </script>
  </body>
</html>
